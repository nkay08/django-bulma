name: Publish

on:
  push:
    branches: [ main ]
  pull_request:
  create:
    tags:
      - '*'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9]
        django-version: [2.2.*, 3.1.*, 3.2.*]

  steps:
    - name: install node & npm
      run: |
        sudo apt-get -yqq update && sudo apt-get install -yqq nodejs npm

    - name: install dependencies
      run: |
        poetry install

    - name: run tests
      run: |
        poetry run tox

  publish:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test]
    steps:

      - name: install node & npm
        run: |
          sudo apt-get -yqq update && sudo apt-get install -yqq nodejs npm

      - name: install dependencies
        run: |
          poetry install

      - name: build
        run: |
          poetry build

      - name: publish
        run: |
          poetry publish
